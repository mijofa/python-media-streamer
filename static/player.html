<!doctype html>
<html>
    <head>
        <!-- FIXME: Host this locally? -->
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
        <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
        <style type="text/css">
            #video-container {
                /* Fill the window, use black-borders */
                position: fixed;
                width: 100%;
                height: 100%;

                top: 0;
                bottom: 0;
                left: 0;
                right: 0;

                background: black;
            }
            #video-player {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;

                z-index: 5
            }
            #video-controls {
                position: absolute;
                width: 100%;
                height: 5%;
                left: 0;
                bottom: 0;

                z-index: 10
            }
            #seek-bar {
                width: 50%;
            }
        </style>
    </head>
    <body>
        <div id="video-container">
            <video autoplay id="video-player">
                If you're reading this, your browser does not support HTML5 video tags. Sorry
            </video>
            <div id="video-controls">
            <!-- FIXME: Add output tags or some basic hover popups to indicate the new value -->
                <button type="button" id="play-pause">Play</button>
                <!-- FIXME: Use a progress element! Oh wait, that doesn't work as an input -->
                <input type="range" id="seek-bar" value="0">
                <button type="button" id="mute">Mute</button>
                <input type="range" id="volume-bar" min="0" max="1" step="0.1" value="1">
                <input type="range" id="brightness-bar" min="0" max="200" step="10" value="100">
                <button type="button" id="full-screen">Full-Screen</button>
            </div>

<script>
window.onload = function() {

  // Video
  var video = document.getElementById("video-player");

  // Buttons
  var playButton = document.getElementById("play-pause");
  var muteButton = document.getElementById("mute");
  var fullScreenButton = document.getElementById("full-screen");

  // Sliders
  var seekBar = document.getElementById("seek-bar");
  var volumeBar = document.getElementById("volume-bar");
  var brightnessBar = document.getElementById("brightness-bar");

// Event listener for the play/pause button
playButton.addEventListener("click", function() {
  if (video.paused == true) {
    // Play the video
    video.play();

    // Update the button text to 'Pause'
    playButton.innerHTML = "Pause";
  } else {
    // Pause the video
    video.pause();

    // Update the button text to 'Play'
    playButton.innerHTML = "Play";
  }
});

// Event listener for the mute button
muteButton.addEventListener("click", function() {
  if (video.muted == false) {
    // Mute the video
    video.muted = true;

    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video.muted = false;

    // Update the button text
    muteButton.innerHTML = "Mute";
  }
});

// Event listener for the full-screen button
fullScreenButton.addEventListener("click", function() {
  if (video.requestFullscreen) {
    video.requestFullscreen();
  } else if (video.mozRequestFullScreen) {
    video.mozRequestFullScreen(); // Firefox
  } else if (video.webkitRequestFullscreen) {
    video.webkitRequestFullscreen(); // Chrome and Safari
  }
});

var vidLength = 6102.8
// Event listener for the seek bar
seekBar.addEventListener("change", function() {
  // Calculate the new time
  var time = vidLength * (seekBar.value / 100);

  // Update the video time
  video.currentTime = time;
});

// Update the seek bar as the video plays
video.addEventListener("timeupdate", function() {
  // Calculate the slider value
  var value = (100 / vidLength) * video.currentTime;

  // Update the slider value
  seekBar.value = value;
});

// Pause the video when the slider handle is being dragged
seekBar.addEventListener("mousedown", function() {
  video.pause();
});
// Play the video when the slider handle is dropped
seekBar.addEventListener("mouseup", function() {
  video.play();
});

// Event listener for the volume bar
volumeBar.addEventListener("change", function() {
  // Update the video volume
  video.volume = volumeBar.value;
});

// Event listener for the brightness bar
brightnessBar.addEventListener("change", function() {
  // Update the video brightness
  // NOTE: Those are backticks, NOT single-quotes.
  //       This makes it an ES6 template string, which allows variable substitution/etc,
  //       but is not supported by all browsers.
  //       https://developers.google.com/web/updates/2015/01/ES6-Template-Strings
  // FIXME: Make ViM understand that so that syntaxhig-highlighting works better
  // FIXME: Don't completely overwrite all filters just to change the brightness one.
  video.style.filter = `brightness(${brightnessBar.value})`;
});
}
</script>

        <!-- Chrome/etc doesn't actually support HLS out of the box, so lets fix that.
             This is just the Getting Started example from the hls.js documentation -->
        <script>
           var video = document.getElementById('video-player');
           if(Hls.isSupported()) {
               var hls = new Hls();
               hls.loadSource(document.URL+'/hls-manifest.m3u8');
               hls.attachMedia(video);
               hls.on(Hls.Events.MANIFEST_PARSED,function() {
                   video.play();
               });
           }
           // hls.js is not supported on platforms that do not have Media Source Extensions (MSE) enabled.
           // When the browser has built-in HLS support (check using `canPlayType`), we can provide an HLS manifest (i.e. .m3u8 URL) directly to the video element throught the `src` property.
           // This is using the built-in support of the plain video element, without using hls.js.
           // Note: it would be more normal to wait on the 'canplay' event below however on Safari (where you are most likely to find built-in HLS support) the video.src URL must be on the user-driven
           // white-list before a 'canplay' event will be emitted; the last video event that can be reliably listened-for when the URL is not on the white-list is 'loadedmetadata'.
           else if (video.canPlayType('application/vnd.apple.mpegurl')) {
               video.src = document.URL+'/hls-manifest.m3u8';
               video.addEventListener('loadedmetadata',function() {
                   video.play();
               });
           }
        </script>

        <!-- Chromecast integration
            This is haphazardly thrown together from Google's Geting started documentation -->
        <script>
// This depends on a thing in the flask app that responds to requests for "/get_ip" with the server's IP address.
// This is only needed because Chromecast is fucking stupid with DNS and refuses to use any network internal DNS servers.
var req = new XMLHttpRequest();
req.open("GET", "/get_ip", true);
req.onload = function(e) { server_ip = req.responseText }
req.send()


window['__onGCastApiAvailable'] = function(loaded, errorInfo) {
  if (loaded) {
    initializeCastApi();
  } else {
    console.log(errorInfo);
  }
}

initializeCastApi = function() {
  var sessionRequest = new chrome.cast.SessionRequest(chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);
  var apiConfig = new chrome.cast.ApiConfig(sessionRequest,
    sessionListener,
    receiverListener);
  chrome.cast.initialize(apiConfig, onInitSuccess, onError);
};

function onInitSuccess() {console.log("Casting initialised")}
function onError(error) {console.log("ERROR!");console.log(error)}

function receiverListener(e) {
  if( e === chrome.cast.ReceiverAvailability.AVAILABLE) {
    console.log("Chromecast listeners are available")
  }
}

function onRequestSessionSuccess(e) {
    console.log("Got session");
    session = e;
}

// My own convenience functions
function init_cast() {
    chrome.cast.requestSession(onRequestSessionSuccess, onError);
}
currentMediaURL = document.URL+'/hls-manifest.m3u8';
function set_media() {
	var mediaInfo = new chrome.cast.media.MediaInfo(currentMediaURL, 'application/x-mpegURL');
	var request = new chrome.cast.media.LoadRequest(mediaInfo);
	session.loadMedia(request,
	   onMediaDiscovered.bind(this, 'loadMedia'),
	   onError);
	
	function onMediaDiscovered(how, media) {
	   currentMedia = media;
	}
}

function onMediaDiscovered(how, media) {
  media.addUpdateListener(onMediaStatusUpdate);
}

function sessionListener(e) {
  session = e;
  if (session.media.length != 0) {
    onMediaDiscovered('onRequestSessionSuccess', session.media[0]);
  }
}

// if (session.status !== chrome.cast.SessionStatus.CONNECTED) {
//     console.log('SessionListener: Session disconnected');
//     // Update local player to disconnected state
// }

function stopApp() {
  session.stop(onSuccess, onError);
}
        </script>
    </body>
</html>
